#!/bin/bash

export THIS_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"

# Parse command line arguments for --chain
CHAIN="ethereum"
for ((i=1; i<=$#; i++)); do
  if [[ "${!i}" == "--chain" && $i -lt $# ]]; then
    j=$((i+1))
    CHAIN="${!j}"
  fi
done

# Read config file
CONFIG_FILE="$HOME/.block-explorer-utils/config.json"
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Config file not found at $CONFIG_FILE"
  echo "Creating directory and example config file. Please edit it with your API keys."
  mkdir -p "$HOME/.block-explorer-utils"
  cp "$THIS_DIR/config.json.example" "$CONFIG_FILE" 2>/dev/null || cat > "$CONFIG_FILE" << EOF
{
  "current-chain": "ethereum",
  "chains": {
    "ethereum": {
      "api_key": "YOUR_INFURA_API_KEY",
      "prefix": "https://mainnet.infura.io/v3",
      "scan_api_key": "YOUR_ETHERSCAN_API_KEY",
      "scan_api_domain": "api.etherscan.io"
    }
  }
}
EOF
  exit 1
fi

# Get current chain from config if not specified in command line
if [[ "$*" != *"--chain"* ]]; then
  CHAIN=$(jq -r '."current-chain" // "ethereum"' "$CONFIG_FILE")
fi

# Update current-chain in config
jq --arg chain "$CHAIN" '.["current-chain"] = $chain' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"

# Get chain-specific configuration
INFURA_API_KEY=$(jq -r ".chains.\"$CHAIN\".api_key" "$CONFIG_FILE")
INFURA_PREFIX=$(jq -r ".chains.\"$CHAIN\".prefix" "$CONFIG_FILE")

if [ "$INFURA_API_KEY" = "" ] || [ "$INFURA_API_KEY" = "null" ]; then
  echo "Please set api_key for chain '$CHAIN' in $CONFIG_FILE"
  exit 1
fi

if [ "$INFURA_PREFIX" = "" ] || [ "$INFURA_PREFIX" = "null" ]; then
  export PREFIX="https://mainnet.infura.io/v3"
else
  export PREFIX="$INFURA_PREFIX"
fi

# Filter out --chain argument for usage check
ARGS=()
SKIP_NEXT=false
for arg in "$@"; do
  if $SKIP_NEXT; then
    SKIP_NEXT=false
    continue
  fi
  if [ "$arg" = "--chain" ]; then
    SKIP_NEXT=true
    continue
  fi
  ARGS+=("$arg")
done

if [ ${#ARGS[@]} -lt 2 ]; then
    echo "Usage: $(basename $0) [--chain <chain-name>] <contract address> <storage slot> [<block>]"
    exit 1
fi

CONTRACT=${ARGS[0]}
SLOT=${ARGS[1]}
BLOCK="${ARGS[2]:-latest}"

echo "Using chain: $CHAIN"
echo -n "$SLOT: "
curl -s $PREFIX/$INFURA_API_KEY \
    -X POST \
    -H "Content-Type: application/json" \
    -d "{\"jsonrpc\":\"2.0\",\"method\":\"eth_getStorageAt\",\"params\": [\"$CONTRACT\", \"$SLOT\", \"$BLOCK\"],\"id\":1}" | jq '.result'
